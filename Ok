-- PRO UI LIB V4 - XỊN SÒ NHƯ RAYFIELD/ORCA, MƯỢT MÀ, FULL FEATURES, NO ERROR
-- Theme Đen Trắng Hòa Quyện Siêu Đẹp: Gradient Glow, Neon Shadow, Animation Pro
-- Hỗ Trợ Mobile/PC Full (Touch Drag, Responsive), Auto Resize, Multi Window
-- Elements: Button, Toggle, Slider, Dropdown, Keybind, ColorPicker, Textbox, Label
-- Bonus: Notify Stack, Watermark, FPS Counter, Custom Fonts (nếu support)

local Library = {}
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TextService = game:GetService("TextService")
local CoreGui = game:GetService("CoreGui")

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ProUILib_V4"
ScreenGui.ResetOnSpawn = false
ScreenGui.DisplayOrder = 1000
ScreenGui.Parent = CoreGui

local Theme = {
    Background = Color3.fromRGB(15, 15, 15),
    Secondary = Color3.fromRGB(25, 25, 25),
    Accent = Color3.fromRGB(255, 255, 255),
    Text = Color3.fromRGB(230, 230, 230),
    Muted = Color3.fromRGB(150, 150, 150),
    Border = Color3.fromRGB(50, 50, 50),
    Glow = Color3.fromRGB(200, 200, 200),
    Error = Color3.fromRGB(255, 80, 80)
}

local Fonts = {
    Title = Enum.Font.SourceSansBold,
    Body = Enum.Font.SourceSans,
    Mono = Enum.Font.Code
}

-- Helper Functions (Improved)
local function Create(instanceType, props)
    local inst = Instance.new(instanceType)
    for prop, value in pairs(props or {}) do
        inst[prop] = value
    end
    return inst
end

local function Corner(inst, radius)
    local c = Create("UICorner", {CornerRadius = UDim.new(0, radius or 6), Parent = inst})
    return c
end

local function Stroke(inst, color, thick, trans)
    local s = Create("UIStroke", {Color = color or Theme.Border, Thickness = thick or 1, Transparency = trans or 0.5, Parent = inst})
    return s
end

local function Gradient(inst, c1, c2, rot)
    local g = Create("UIGradient", {Color = ColorSequence.new(c1, c2), Rotation = rot or 45, Parent = inst})
    return g
end

local function Tween(inst, props, duration, style, direction)
    local info = TweenInfo.new(duration or 0.3, style or Enum.EasingStyle.Quart, direction or Enum.EasingDirection.Out)
    TweenService:Create(inst, info, props):Play()
end

local function RippleEffect(button)
    button.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            local ripple = Create("Frame", {BackgroundColor3 = Theme.Glow, BackgroundTransparency = 0.7, Size = UDim2.new(0, 0, 0, 0), Position = UDim2.new(0.5, 0, 0.5, 0), AnchorPoint = Vector2.new(0.5, 0.5), Parent = button, ZIndex = 10})
            Corner(ripple, 999)
            local mousePos = button.AbsolutePosition
            ripple.Position = UDim2.new((input.Position.X - mousePos.X) / button.AbsoluteSize.X, 0, (input.Position.Y - mousePos.Y) / button.AbsoluteSize.Y, 0)
            Tween(ripple, {Size = UDim2.new(4, 0, 4, 0), BackgroundTransparency = 1}, 0.5, Enum.EasingStyle.Quart)
            task.delay(0.5, function() ripple:Destroy() end)
        end
    end)
end

-- Mobile Toggle Button (Floating)
local isMobile = UserInputService.TouchEnabled
local MobileToggleBtn = Create("TextButton", {Size = UDim2.new(0, 60, 0, 60), Position = UDim2.new(1, -80, 1, -80), BackgroundColor3 = Theme.Secondary, Text = "UI", TextColor3 = Theme.Accent, TextSize = 24, Font = Fonts.Title, Visible = isMobile, Parent = ScreenGui})
Corner(MobileToggleBtn, 30)
Stroke(MobileToggleBtn, Theme.Glow, 1.5)
RippleEffect(MobileToggleBtn)

MobileToggleBtn.MouseButton1Click:Connect(function()
    ScreenGui.Enabled = not ScreenGui.Enabled
end)

-- Notify System (Stackable, Animated)
local NotifyHolder = Create("Frame", {Size = UDim2.new(0, 350, 1, 0), Position = UDim2.new(1, -370, 0, 0), BackgroundTransparency = 1, Parent = ScreenGui})
local NotifyLayout = Create("UIListLayout", {SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 10), VerticalAlignment = Enum.VerticalAlignment.Bottom, Parent = NotifyHolder})

function Library:Notify(title, description, duration, callback)
    duration = duration or 5
    local Notif = Create("Frame", {Size = UDim2.new(1, 0, 0, 80), BackgroundColor3 = Theme.Background, Parent = NotifyHolder})
    Corner(Notif, 12)
    Stroke(Notif, Theme.Accent)
    Gradient(Notif, Theme.Background, Theme.Secondary)
    RippleEffect(Notif)

    local NotifTitle = Create("TextLabel", {Size = UDim2.new(1, -20, 0, 30), Position = UDim2.new(0, 10, 0, 10), BackgroundTransparency = 1, Text = title, TextColor3 = Theme.Accent, Font = Fonts.Title, TextSize = 18, TextXAlignment = Enum.TextXAlignment.Left, Parent = Notif})

    local NotifDesc = Create("TextLabel", {Size = UDim2.new(1, -20, 0, 40), Position = UDim2.new(0, 10, 0, 35), BackgroundTransparency = 1, Text = description, TextColor3 = Theme.Text, Font = Fonts.Body, TextSize = 14, TextWrapped = true, TextXAlignment = Enum.TextXAlignment.Left, Parent = Notif})

    Tween(Notif, {Position = UDim2.new(0, 20, 0, 0)})
    task.delay(duration, function()
        Tween(Notif, {Position = UDim2.new(0, -370, 0, 0)})
        task.delay(0.3, function() Notif:Destroy() if callback then callback() end end)
    end)
end

-- Window Creation
function Library:CreateWindow(options)
    options = options or {}
    local windowTitle = options.Name or "Pro Executor"
    local windowSize = options.Size or Vector2.new(650, 450)

    local Window = {Tabs = {}, Elements = {}}
    local Main = Create("Frame", {Size = UDim2.fromOffset(windowSize.X, windowSize.Y), Position = UDim2.new(0.5, -windowSize.X/2, 0.5, -windowSize.Y/2), BackgroundColor3 = Theme.Background, ClipsDescendants = true, Parent = ScreenGui})
    Corner(Main, 14)
    Stroke(Main, Theme.Glow, 1, 0.3)
    Gradient(Main, Theme.Background, Theme.Secondary, 135)

    -- Shadow
    local Shadow = Create("ImageLabel", {Size = UDim2.new(1, 40, 1, 40), Position = UDim2.new(0, -20, 0, -20), BackgroundTransparency = 1, Image = "rbxassetid://6015897843", ImageColor3 = Color3.new(0,0,0), ImageTransparency = 0.5, ScaleType = Enum.ScaleType.Slice, SliceCenter = Rect.new(49, 49, 451, 451), ZIndex = -1, Parent = Main})

    -- Header
    local Header = Create("Frame", {Size = UDim2.new(1, 0, 0, 50), BackgroundTransparency = 1, Parent = Main})
    local HeaderBg = Create("Frame", {Size = UDim2.new(1, 0, 1, 0), BackgroundColor3 = Theme.Secondary, Parent = Header})
    Corner(HeaderBg, 14)
    Gradient(HeaderBg, Theme.Secondary, Theme.Background, 90)

    local Title = Create("TextLabel", {Size = UDim2.new(1, -120, 1, 0), Position = UDim2.new(0, 20, 0, 0), BackgroundTransparency = 1, Text = windowTitle, TextColor3 = Theme.Accent, Font = Fonts.Title, TextSize = 20, TextXAlignment = Enum.TextXAlignment.Left, Parent = Header})

    -- Minimize & Close Buttons
    local MinBtn = Create("TextButton", {Size = UDim2.new(0, 32, 0, 32), Position = UDim2.new(1, -75, 0.5, -16), BackgroundColor3 = Theme.Muted, Text = "-", TextColor3 = Theme.Accent, Font = Fonts.Title, TextSize = 20, Parent = Header})
    Corner(MinBtn, 8)
    Stroke(MinBtn, Theme.Glow)
    RippleEffect(MinBtn)

    local CloseBtn = Create("TextButton", {Size = UDim2.new(0, 32, 0, 32), Position = UDim2.new(1, -40, 0.5, -16), BackgroundColor3 = Theme.Error, Text = "X", TextColor3 = Theme.Accent, Font = Fonts.Title, TextSize = 20, Parent = Header})
    Corner(CloseBtn, 8)
    Stroke(CloseBtn, Theme.Glow)
    RippleEffect(CloseBtn)

    -- Tab Bar
    local TabBar = Create("Frame", {Size = UDim2.new(1, -30, 0, 40), Position = UDim2.new(0, 15, 0, 55), BackgroundColor3 = Theme.Secondary, Parent = Main})
    Corner(TabBar, 10)
    Stroke(TabBar, Theme.Border)

    local TabBarLayout = Create("UIListLayout", {FillDirection = Enum.FillDirection.Horizontal, Padding = UDim.new(0, 10), VerticalAlignment = Enum.VerticalAlignment.Center, Parent = TabBar})

    -- Content Frame
    local ContentContainer = Create("Frame", {Size = UDim2.new(1, -30, 1, -110), Position = UDim2.new(0, 15, 0, 100), BackgroundTransparency = 1, Parent = Main})

    local activeTab = nil

    -- Dragging (Mobile/PC Compatible)
    local dragging = false
    local dragStart, startPos
    Header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = Main.Position
            local conn
            conn = input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    conn:Disconnect()
                end
            end)
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)

    -- Minimize/Close
    local minimized = false
    MinBtn.MouseButton1Click:Connect(function()
        minimized = not minimized
        Tween(Main, {Size = minimized and UDim2.new(0, windowSize.X, 0, 50) or UDim2.new(0, windowSize.X, 0, windowSize.Y)})
        ContentContainer.Visible = not minimized
        TabBar.Visible = not minimized
        MinBtn.Text = minimized and "+" or "-"
    end)

    CloseBtn.MouseButton1Click:Connect(function()
        Main:Destroy()
    end)

    -- Create Tab
    function Window:CreateTab(tabOptions)
        tabOptions = tabOptions or {}
        local tabName = tabOptions.Name or "Tab"
        local tabIcon = tabOptions.Icon or ""

        local Tab = {Sections = {}}
        local TabButton = Create("TextButton", {Size = UDim2.new(0, TextService:GetTextSize(tabIcon .. tabName, 16, Fonts.Body, Vector2.new(math.huge, math.huge)).X + 20, 1, -10), BackgroundTransparency = 1, Text = tabIcon .. " " .. tabName, TextColor3 = Theme.Muted, Font = Fonts.Body, TextSize = 16, Parent = TabBar})
        local TabIndicator = Create("Frame", {Size = UDim2.new(1, 0, 0, 3), Position = UDim2.new(0, 0, 1, 0), BackgroundColor3 = Theme.Accent, BackgroundTransparency = 1, Parent = TabButton})
        Corner(TabIndicator, 2)
        Gradient(TabIndicator, Theme.Accent, Theme.Glow)

        local TabContent = Create("ScrollingFrame", {Size = UDim2.new(1, 0, 1, 0), BackgroundTransparency = 1, ScrollBarThickness = 3, ScrollBarImageColor3 = Theme.Border, Visible = false, Parent = ContentContainer})
        local TabContentLayout = Create("UIListLayout", {Padding = UDim.new(0, 10), Parent = TabContent})
        TabContentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            TabContent.CanvasSize = UDim2.new(0, 0, 0, TabContentLayout.AbsoluteContentSize.Y + 20)
        end)

        local function ActivateTab()
            if activeTab then
                activeTab.Visible = false
                local oldButton = TabBar:FindFirstChildOfClass("TextButton") -- Tìm button cũ
                if oldButton then
                    Tween(oldButton, {TextColor3 = Theme.Muted})
                    local oldIndicator = oldButton:FindFirstChild("Frame")
                    if oldIndicator then
                        Tween(oldIndicator, {BackgroundTransparency = 1})
                    end
                end
            end
            TabContent.Visible = true
            activeTab = TabContent
            Tween(TabButton, {TextColor3 = Theme.Accent})
            Tween(TabIndicator, {BackgroundTransparency = 0})
        end

        TabButton.MouseButton1Click:Connect(ActivateTab)
        TabButton.MouseEnter:Connect(function()
            if not TabContent.Visible then Tween(TabButton, {TextColor3 = Theme.Text}) end
        end)
        TabButton.MouseLeave:Connect(function()
            if not TabContent.Visible then Tween(TabButton, {TextColor3 = Theme.Muted}) end
        end)

        if not activeTab then ActivateTab() end

        -- Create Section
        function Tab:CreateSection(secOptions)
            secOptions = secOptions or {}
            local secName = secOptions.Name or "Section"

            local Section = {Elements = {}}
            local SecFrame = Create("Frame", {Size = UDim2.new(1, 0, 0, 40), BackgroundColor3 = Theme.Secondary, Parent = TabContent})
            Corner(SecFrame, 10)
            Stroke(SecFrame, Theme.Border)
            Gradient(SecFrame, Theme.Secondary, Theme.Background)

            local SecTitle = Create("TextLabel", {Size = UDim2.new(1, -20, 0, 30), Position = UDim2.new(0, 10, 0, 5), BackgroundTransparency = 1, Text = secName, TextColor3 = Theme.Accent, Font = Fonts.Title, TextSize = 17, TextXAlignment = Enum.TextXAlignment.Left, Parent = SecFrame})

            local SecContainer = Create("Frame", {Size = UDim2.new(1, -20, 1, -40), Position = UDim2.new(0, 10, 0, 35), BackgroundTransparency = 1, Parent = SecFrame})
            local SecLayout = Create("UIListLayout", {Padding = UDim.new(0, 8), Parent = SecContainer})
            SecLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                SecFrame.Size = UDim2.new(1, 0, 0, SecLayout.AbsoluteContentSize.Y + 50)
            end)

            -- Elements in Section

            function Section:AddLabel(text)
                local Label = Create("TextLabel", {Size = UDim2.new(1, 0, 0, 25), BackgroundTransparency = 1, Text = text, TextColor3 = Theme.Text, Font = Fonts.Body, TextSize = 15, TextXAlignment = Enum.TextXAlignment.Left, Parent = SecContainer})
                return Label
            end

            function Section:AddButton(btnOptions)
                btnOptions = btnOptions or {}
                local btnText = btnOptions.Text or "Button"
                local callback = btnOptions.Callback or function() end

                local Button = Create("TextButton", {Size = UDim2.new(1, 0, 0, 40), BackgroundColor3 = Theme.Background, Text = btnText, TextColor3 = Theme.Text, Font = Fonts.Body, TextSize = 15, Parent = SecContainer})
                Corner(Button, 8)
                Stroke(Button, Theme.Accent, 1.2)
                RippleEffect(Button)

                Button.MouseButton1Click:Connect(callback)
                Button.MouseEnter:Connect(function() Tween(Button, {BackgroundColor3 = Theme.Muted}) end)
                Button.MouseLeave:Connect(function() Tween(Button, {BackgroundColor3 = Theme.Background}) end)
                return Button
            end

            function Section:AddToggle(togOptions)
                togOptions = togOptions or {}
                local togText = togOptions.Text or "Toggle"
                local default = togOptions.Default or false
                local callback = togOptions.Callback or function(state) end

                local Toggle = {Value = default}
                local TogFrame = Create("Frame", {Size = UDim2.new(1, 0, 0, 40), BackgroundTransparency = 1, Parent = SecContainer})

                local TogLabel = Create("TextLabel", {Size = UDim2.new(1, -60, 1, 0), Position = UDim2.new(0, 0, 0, 0), BackgroundTransparency = 1, Text = togText, TextColor3 = Theme.Text, Font = Fonts.Body, TextSize = 15, TextXAlignment = Enum.TextXAlignment.Left, Parent = TogFrame})

                local TogSwitch = Create("Frame", {Size = UDim2.new(0, 50, 0, 24), Position = UDim2.new(1, -50, 0.5, -12), BackgroundColor3 = Theme.Muted, Parent = TogFrame})
                Corner(TogSwitch, 12)
                Stroke(TogSwitch, Theme.Border)

                local TogKnob = Create("Frame", {Size = UDim2.new(0, 20, 0, 20), Position = UDim2.new(0, 2, 0.5, -10), BackgroundColor3 = Theme.Accent, Parent = TogSwitch})
                Corner(TogKnob, 10)

                local function Set(state)
                    Toggle.Value = state
                    Tween(TogSwitch, {BackgroundColor3 = state and Theme.Accent or Theme.Muted})
                    Tween(TogKnob, {Position = state and UDim2.new(1, -22, 0.5, -10) or UDim2.new(0, 2, 0.5, -10)})
                    callback(state)
                end

                TogSwitch.MouseButton1Click:Connect(function() Set(not Toggle.Value) end)
                if default then Set(true) end
                return Toggle
            end

            function Section:AddSlider(sliderOptions)
                sliderOptions = sliderOptions or {}
                local sliderText = sliderOptions.Text or "Slider"
                local min = sliderOptions.Min or 0
                local max = sliderOptions.Max or 100
                local default = math.clamp(sliderOptions.Default or min, min, max)
                local step = sliderOptions.Step or 1
                local callback = sliderOptions.Callback or function(val) end

                local Slider = {Value = default}
                local SliderFrame = Create("Frame", {Size = UDim2.new(1, 0, 0, 50), BackgroundTransparency = 1, Parent = SecContainer})

                local SliderLabel = Create("TextLabel", {Size = UDim2.new(1, 0, 0, 20), BackgroundTransparency = 1, Text = sliderText .. ": " .. default, TextColor3 = Theme.Text, Font = Fonts.Body, TextSize = 15, TextXAlignment = Enum.TextXAlignment.Left, Parent = SliderFrame})

                local SliderBg = Create("Frame", {Size = UDim2.new(1, 0, 0, 8), Position = UDim2.new(0, 0, 0, 30), BackgroundColor3 = Theme.Muted, Parent = SliderFrame})
                Corner(SliderBg, 4)
                Stroke(SliderBg, Theme.Border)

                local SliderFill = Create("Frame", {Size = UDim2.new((default - min) / (max - min), 0, 1, 0), BackgroundColor3 = Theme.Accent, Parent = SliderBg})
                Corner(SliderFill, 4)

                local dragging = false
                SliderBg.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                        dragging = true
                    end
                end)
                UserInputService.InputEnded:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                        dragging = false
                    end
                end)
                UserInputService.InputChanged:Connect(function(input)
                    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                        local perc = math.clamp((input.Position.X - SliderBg.AbsolutePosition.X) / SliderBg.AbsoluteSize.X, 0, 1)
                        local val = math.floor((min + (max - min) * perc) / step) * step
                        Slider.Value = val
                        SliderLabel.Text = sliderText .. ": " .. val
                        Tween(SliderFill, {Size = UDim2.new(perc, 0, 1, 0)})
                        callback(val)
                    end
                end)
                return Slider
            end

            function Section:AddDropdown(ddOptions)
                ddOptions = ddOptions or {}
                local ddText = ddOptions.Text or "Dropdown"
                local options = ddOptions.Options or {}
                local default = ddOptions.Default or options[1]
                local callback = ddOptions.Callback or function(val) end

                local Dropdown = {Value = default}
                local DdFrame = Create("Frame", {Size = UDim2.new(1, 0, 0, 40), BackgroundColor3 = Theme.Background, Parent = SecContainer})
                Corner(DdFrame, 8)
                Stroke(DdFrame, Theme.Accent)

                local DdLabel = Create("TextLabel", {Size = UDim2.new(1, -40, 1, 0), Position = UDim2.new(0, 10, 0, 0), BackgroundTransparency = 1, Text = ddText .. ": " .. default, TextColor3 = Theme.Text, Font = Fonts.Body, TextSize = 15, TextXAlignment = Enum.TextXAlignment.Left, Parent = DdFrame})

                local DdArrow = Create("TextLabel", {Size = UDim2.new(0, 30, 1, 0), Position = UDim2.new(1, -35, 0, 0), BackgroundTransparency = 1, Text = "▼", TextColor3 = Theme.Accent, Font = Fonts.Body, TextSize = 18, Parent = DdFrame})

                local DdList = Create("ScrollingFrame", {Size = UDim2.new(1, 0, 0, 0), Position = UDim2.new(0, 0, 1, 0), BackgroundColor3 = Theme.Secondary, Visible = false, ScrollBarThickness = 3, Parent = DdFrame})
                Corner(DdList, 8)
                Stroke(DdList, Theme.Border)

                local DdLayout = Create("UIListLayout", {Padding = UDim.new(0, 5), Parent = DdList})
                DdLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                    DdList.CanvasSize = UDim2.new(0, 0, 0, DdLayout.AbsoluteContentSize.Y)
                end)

                local opened = false
                DdFrame.MouseButton1Click:Connect(function()
                    opened = not opened
                    local height = math.min(DdLayout.AbsoluteContentSize.Y, 150)
                    Tween(DdList, {Size = opened and UDim2.new(1, 0, 0, height) or UDim2.new(1, 0, 0, 0)})
                    DdList.Visible = opened
                    Tween(DdArrow, {Rotation = opened and 180 or 0})
                end)

                for _, opt in ipairs(options) do
                    local OptBtn = Create("TextButton", {Size = UDim2.new(1, 0, 0, 30), BackgroundTransparency = 1, Text = opt, TextColor3 = Theme.Text, Font = Fonts.Body, TextSize = 15, Parent = DdList})
                    OptBtn.MouseButton1Click:Connect(function()
                        Dropdown.Value = opt
                        DdLabel.Text = ddText .. ": " .. opt
                        callback(opt)
                        opened = false
                        Tween(DdList, {Size = UDim2.new(1, 0, 0, 0)})
                        DdList.Visible = false
                        Tween(DdArrow, {Rotation = 0})
                    end)
                    OptBtn.MouseEnter:Connect(function() Tween(OptBtn, {TextColor3 = Theme.Accent}) end)
                    OptBtn.MouseLeave:Connect(function() Tween(OptBtn, {TextColor3 = Theme.Text}) end)
                end

                return Dropdown
            end

            function Section:AddKeybind(kbOptions)
                kbOptions = kbOptions or {}
                local kbText = kbOptions.Text or "Keybind"
                local default = kbOptions.Default or Enum.KeyCode.Unknown
                local callback = kbOptions.Callback or function(key) end

                local Keybind = {Value = default}
                local KbFrame = Create("Frame", {Size = UDim2.new(1, 0, 0, 40), BackgroundTransparency = 1, Parent = SecContainer})

                local KbLabel = Create("TextLabel", {Size = UDim2.new(1, -80, 1, 0), Position = UDim2.new(0, 0, 0, 0), BackgroundTransparency = 1, Text = kbText, TextColor3 = Theme.Text, Font = Fonts.Body, TextSize = 15, TextXAlignment = Enum.TextXAlignment.Left, Parent = KbFrame})

                local KbButton = Create("TextButton", {Size = UDim2.new(0, 70, 0, 30), Position = UDim2.new(1, -70, 0.5, -15), BackgroundColor3 = Theme.Background, Text = default.Name, TextColor3 = Theme.Accent, Font = Fonts.Mono, TextSize = 14, Parent = KbFrame})
                Corner(KbButton, 8)
                Stroke(KbButton, Theme.Border)
                RippleEffect(KbButton)

                local binding = false
                KbButton.MouseButton1Click:Connect(function()
                    binding = true
                    KbButton.Text = "..."
                end)

                UserInputService.InputBegan:Connect(function(input, gpe)
                    if binding and not gpe and input.UserInputType == Enum.UserInputType.Keyboard then
                        Keybind.Value = input.KeyCode
                        KbButton.Text = input.KeyCode.Name
                        binding = false
                        callback(input.KeyCode)
                    end
                end)

                return Keybind
            end

            function Section:AddColorPicker(cpOptions)
                cpOptions = cpOptions or {}
                local cpText = cpOptions.Text or "Color Picker"
                local default = cpOptions.Default or Color3.fromRGB(255, 255, 255)
                local callback = cpOptions.Callback or function(color) end

                local ColorPicker = {Value = default}
                local CpFrame = Create("Frame", {Size = UDim2.new(1, 0, 0, 40), BackgroundTransparency = 1, Parent = SecContainer})

                local CpLabel = Create("TextLabel", {Size = UDim2.new(1, -60, 1, 0), Position = UDim2.new(0, 0, 0, 0), BackgroundTransparency = 1, Text = cpText, TextColor3 = Theme.Text, Font = Fonts.Body, TextSize = 15, TextXAlignment = Enum.TextXAlignment.Left, Parent = CpFrame})

                local CpPreview = Create("Frame", {Size = UDim2.new(0, 50, 0, 30), Position = UDim2.new(1, -50, 0.5, -15), BackgroundColor3 = default, Parent = CpFrame})
                Corner(CpPreview, 6)
                Stroke(CpPreview, Theme.Border)

                local opened = false
                CpPreview.MouseButton1Click:Connect(function()
                    opened = not opened
                    -- Mở picker panel (simple RGB sliders for now)
                    if opened then
                        local PickerPanel = Create("Frame", {Size = UDim2.new(1, 0, 0, 150), Position = UDim2.new(0, 0, 1, 5), BackgroundColor3 = Theme.Secondary, Parent = CpFrame})
                        Corner(PickerPanel, 10)
                        Stroke(PickerPanel, Theme.Border)

                        -- Add RGB Sliders
                        local function AddRgbSlider(label, colorIndex, defaultVal)
                            local SliderFrame = Create("Frame", {Size = UDim2.new(1, -10, 0, 40), Position = UDim2.new(0, 5, 0, (colorIndex-1)*40 + 10), BackgroundTransparency = 1, Parent = PickerPanel})

                            local SLabel = Create("TextLabel", {Size = UDim2.new(0.2, 0, 1, 0), Text = label, TextColor3 = Theme.Text, BackgroundTransparency = 1, Parent = SliderFrame})

                            local SBg = Create("Frame", {Size = UDim2.new(0.8, 0, 0, 8), Position = UDim2.new(0.2, 10, 0.5, -4), BackgroundColor3 = Theme.Muted, Parent = SliderFrame})
                            Corner(SBg, 4)

                            local SFill = Create("Frame", {Size = UDim2.new(defaultVal/255, 0, 1, 0), BackgroundColor3 = Theme.Accent, Parent = SBg})
                            Corner(SFill, 4)

                            local sDrg = false
                            SBg.InputBegan:Connect(function(inp) if inp.UserInputType == Enum.UserInputType.MouseButton1 then sDrg = true end end)
                            UserInputService.InputEnded:Connect(function(inp) if inp.UserInputType == Enum.UserInputType.MouseButton1 then sDrg = false end end)
                            UserInputService.InputChanged:Connect(function(inp)
                                if sDrg then
                                    local p = math.clamp((inp.Position.X - SBg.AbsolutePosition.X) / SBg.AbsoluteSize.X, 0, 1)
                                    local val = math.floor(p * 255)
                                    local r, g, b = ColorPicker.Value.R * 255, ColorPicker.Value.G * 255, ColorPicker.Value.B * 255
                                    if colorIndex == 1 then r = val elseif colorIndex == 2 then g = val else b = val end
                                    ColorPicker.Value = Color3.fromRGB(r, g, b)
                                    CpPreview.BackgroundColor3 = ColorPicker.Value
                                    Tween(SFill, {Size = UDim2.new(p, 0, 1, 0)})
                                    callback(ColorPicker.Value)
                                end
                            end)
                        end

                        AddRgbSlider("R", 1, default.R * 255)
                        AddRgbSlider("G", 2, default.G * 255)
                        AddRgbSlider("B", 3, default.B * 255)

                        Tween(PickerPanel, {Size = UDim2.new(1, 0, 0, 150)})
                    else
                        local panel = CpFrame:FindFirstChild("Frame")
                        if panel then
                            Tween(panel, {Size = UDim2.new(1, 0, 0, 0)})
                            task.delay(0.3, function() panel:Destroy() end)
                        end
                    end
                end)

                return ColorPicker
            end

            function Section:AddTextbox(tbOptions)
                tbOptions = tbOptions or {}
                local tbText = tbOptions.Text or "Textbox"
                local default = tbOptions.Default or ""
                local callback = tbOptions.Callback or function(txt) end

                local Textbox = {Value = default}
                local TbFrame = Create("Frame", {Size = UDim2.new(1, 0, 0, 40), BackgroundTransparency = 1, Parent = SecContainer})

                local TbLabel = Create("TextLabel", {Size = UDim2.new(0.5, 0, 1, 0), Position = UDim2.new(0, 0, 0, 0), BackgroundTransparency = 1, Text = tbText, TextColor3 = Theme.Text, Font = Fonts.Body, TextSize = 15, TextXAlignment = Enum.TextXAlignment.Left, Parent = TbFrame})

                local TbInput = Create("TextBox", {Size = UDim2.new(0.5, 0, 1, 0), Position = UDim2.new(0.5, 0, 0, 0), BackgroundColor3 = Theme.Background, Text = default, TextColor3 = Theme.Accent, Font = Fonts.Mono, TextSize = 14, Parent = TbFrame})
                Corner(TbInput, 8)
                Stroke(TbInput, Theme.Border)

                TbInput.FocusLost:Connect(function(enter)
                    if enter then
                        Textbox.Value = TbInput.Text
                        callback(TbInput.Text)
                    end
                end)

                return Textbox
            end

            return Section
        end

        return Tab
    end

    return Window
end

-- UI Toggle with Insert
UserInputService.InputBegan:Connect(function(input, gp)
    if not gp and input.KeyCode == Enum.KeyCode.Insert then
        ScreenGui.Enabled = not ScreenGui.Enabled
    end
end)

return Library
